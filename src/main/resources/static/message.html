<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, 
                                     initial-scale=1.0, 
                                     maximum-scale=1.0, 
                                     user-scalable=no">
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/init.css" rel="stylesheet">
        

 
        <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
        <script src="js/jquery.min.js" charset="utf-8"></script>
         
        <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
        <script src="js/bootstrap.min.js" charset="utf-8"></script>
        <script src="js/underscore.js" charset="utf-8"></script>
        <script src="http://cdn.bootcss.com/sockjs-client/1.1.1/sockjs.min.js"></script>
        <script src="http://cdn.bootcss.com/stomp.js/2.3.3/stomp.js"></script>
        <script src="js/assist.js" charset="utf-8"></script>
        <script src="js/base.js" charset="utf-8"></script>
        
        <title>我的客户</title>
    </head>
    <body>
		<nav class="container navbar-fixed-top navbar">
        	<div class="row clearfix navbox">
                
                <div class="col-xs-1">
                    <h4><i class="fa fa-angle-left"></i></h4>
                </div>
                <div class="col-xs-10">
                    <h3 class="text-center">我的客户</h3>
                </div>
                <div class="col-xs-1">
                </div>
            </div>
            
		</nav>
         
        <div class="container message" id="BDTJList">
            
            
            <!--div class="row clearfix bd">
            	
            	<div class="col-xs-3">
                	<img src="img/face.jpg" class="img-responsive" />
                </div>
                <div class="col-xs-6">
                    <h6>你好</h6>
                </div>
                <div class="col-xs-3">
                    <img src="img/face.jpg" class="img-responsive" />
                </div>

            </div-->
            
        </div>

        <div class="container navbar-fixed-bottom messageinput">
            <div class="row clearfix">
            <form action="" onsubmit="return false" >
                <div class="col-xs-10 mpclear ">
                    <input class="form-control" id="message" type="text" placeholder="请输入内容">
                </div>
                <div class="col-xs-2 mpclear">
                    <button class="btn btn-primary" onclick="sendMsg()">发送</button>
                </div>
            </form>   
            </div>
        </div>
    </body>
</html>
<script id="BDitemL" type="text/template">
    <div class="row clearfix bd">
        <div class="col-xs-12 text-center">
            <span class="label label-info"><%= createtime %></span>
        </div>        
        <div class="col-xs-2 mpclear">
            <img src="<%= fromuserid %>" class="img-responsive" />
        </div>
        <div class="col-xs-8">
            <i class="fa  fa-caret-left"></i>
            <h6 class="messboxL"><%= content %></h6>

        </div>
        <div class="col-xs-2 mpclear">
            <img src="<%= touserid %>" class="img-responsive" />
            
        </div>

    </div>

</script>
<script id="BDitemR" type="text/template">
    <div class="row clearfix bd">
        <div class="col-xs-12 text-center">
            <span class="label label-info"><%= createtime %></span>
        </div>       
        <div class="col-xs-2 mpclear">
            <img src="<%= touserid %>" class="img-responsive" />
        </div>
        <div class="col-xs-8">
            <i class="fa fa-caret-right"></i>
            <h6 class="messboxR"><%= content %></h6>
        </div>
        <div class="col-xs-2 mpclear">
            <img src="<%= fromuserid %>" class="img-responsive" />
        </div>

    </div>

</script>


<script type="text/javascript">
$(document).ready(function () {
    userready();
	connect();
});
//数据准备
</script>
<script type="text/javascript">


    var stompClient = null;

    function setConnected(connected) {
        document.getElementById('connect').disabled = connected;
        document.getElementById('disconnect').disabled = !connected;

        document.getElementById('fromuserid').disabled = connected;
        document.getElementById('touserid').disabled = connected;
    }

    function getLocalTime(nS) {
        return new Date(parseInt(nS)).toLocaleString().replace(/:\d{1,2}$/,' ');
    }

    //this line.
    function ajax(url, param, func) {
        $.ajax({
            url: url,
            type: 'POST', //GET
            async: true,    //或false,是否异步
            data: param,
            timeout: 5000,    //超时时间
            dataType: 'json',    //返回的数据格式：json/xml/html/script/jsonp/text
            beforeSend: function (xhr) {
                //console.log(xhr);
                //console.log('发送前');
            },
            success: function (data, textStatus, jqXHR) {
                //console.log(data);
                //console.log(textStatus);
                //console.log(jqXHR);
                func && func(data);
            },
            error: function (xhr, textStatus) {
                //console.log('错误');
                //console.log(xhr);
                //console.log(textStatus);
            },
            complete: function () {
                //console.log('结束');
            }
        })
    }

    function queryUnreadMsg(fromuserid) {
        var url = DOMAIN+"/msg/queryUnreadMessageByToUserId";
        ajax(url, {"toUserId" : fromuserid}, function(data){showRespMsg(data);});
    }
    function queryHistoryMsg(fromuserid,touserid) {
        var url = DOMAIN+"/msg/queryHistoryMessage";
        ajax(url, {"toUserId" : fromuserid,"fromUserId":touserid}, function(data){showRespMsg(data);});
    }

    function markMsgRead(fromuserid) {
        var url = DOMAIN+"/msg/markMessageReadByToUserId";
        ajax(url, {"toUserId" : fromuserid});
    }

    function connect() {
        var fromuserid = getUrlParam("oid");
        var touserid = getUrlParam("toid");

        if(!fromuserid || !touserid){
            layer.msg("请输入发送方和接收方");
            return false;
        }

        var socket = new SockJS(DOMAIN+"/ws/connect");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            //setConnected(true);
            //console.log('Connected: ' + frame);

            stompClient.subscribe('/user/' + fromuserid + '/message',function(greeting){
                showMsg(JSON.parse(greeting.body));
            });

            queryHistoryMsg(fromuserid,touserid);

            //queryUnreadMsg(fromuserid);//得到未读消息

            markMsgRead(fromuserid);//标记未读消息为已读
        });
    }

    function disconnect() {
        if (stompClient != null) {
            stompClient.disconnect();
        }
        //setConnected(false);
        //console.log("Disconnected");
    }


    function showRespMsg(msg) {
        if(msg.retCode == '1'){//成功
            var tmpArr = msg.data;
            showMsg(tmpArr);
        }
    }

    function showMsg(msg) {
        
        if(msg instanceof Array){
            for(v = msg.length-1;v >= 0;v--){

                if(msg[v].fromuserid == getUrlParam("oid")){
                        var row = {
                            "fromuserid":fromheadimg(),
                            "touserid":"img/blank.png", 
                            "createtime":getmessagetime(msg[v].createtime), 
                            "content":msg[v].content
                        }

                        var text=$("#BDitemR").text();
                        var compiled = _.template(text);
                        rs=compiled(row);
                        
                        $("#BDTJList").append(rs);
                    }else{
                        var row = {
                            "fromuserid":toheadimg(),
                            "touserid":"img/blank.png", 
                            "createtime":getmessagetime(msg[v].createtime), 
                            "content":msg[v].content
                        }

                        var text=$("#BDitemL").text();
                        var compiled = _.template(text);
                        rs=compiled(row);
                        
                        $("#BDTJList").append(rs);
                }
                
                
            }
        } else{
            

            if(msg.fromuserid == getUrlParam("oid")){
                    var row = {
                        "fromuserid":fromheadimg(),
                        "touserid":"img/blank.png", 
                        "createtime":getmessagetime(msg.createtime), 
                        "content":msg.content
                    }

                    var text=$("#BDitemR").text();
                    var compiled = _.template(text);
                    rs=compiled(row);
                    
                    $("#BDTJList").append(rs);
                }else{
                    var row = {
                        "fromuserid":toheadimg(),
                        "touserid":"img/blank.png", 
                        "createtime":getmessagetime(msg.createtime), 
                        "content":msg.content
                    }

                    var text=$("#BDitemL").text();
                    var compiled = _.template(text);
                    rs=compiled(row);
                    
                    $("#BDTJList").append(rs);
                }
                
            
        }
        
        $("body").get(0).scrollTop = $("body").get(0).scrollHeight;

    }

    function sendMsg(){
        var fromuserid = getUrlParam("oid");
        var touserid = getUrlParam("toid");
        var content = $('#message').val();

        if(!fromuserid || !touserid || !content){
            layer.msg("请输入发送方、接收方、内容");
            return false;
        }

        if(stompClient == null){
            layer.msg("请先上线");
        }

        $('#message').val("");

        var url = DOMAIN+"/msg/sendMessage";
        var param = {"fromuserid":fromuserid,"touserid":touserid,"content":content};
        ajax(url, {"data":JSON.stringify(param)}, function(data){showRespMsg(data);});
    }
//----
var oiduser="";
function userready () {
        var url=DOMAIN + "/user/queryAgentByOidNoToken";
        var data={
            "oid":getUrlParam("oid")
            };
        //console.log(data);
        var success = function(data, textStatus, jqXHR){
            //console.log(data)
            if (data.data != null && data.retCode == 1) {
                    oiduser=data.data;
                    userready2();
                }
        };
        $.post(url,data,success,"json");    

}
function fromheadimg () {
    if(oiduser.ipath == "" || oiduser.ipath == null){
        return "img/default.png";
    }else{
        return oiduser.ipath;
    }
}
var toiduser="";
function userready2() {//customerinfo
        var url=DOMAIN + "/cust/oneCustNoToken";
        var data={
            "coid":getUrlParam("toid")
            };
        //console.log(data);
        var success = function(data, textStatus, jqXHR){
            //console.log(data)
            if (data.data != null && data.retCode == 1) {
                    toiduser=data.data;
                    $(".navbar .text-center").html(toiduser.name)
                }else {
                    //
                }
            
        };
        $.post(url,data,success,"json");
        
        
    }
function toheadimg () {
    if(toiduser.ipath == "" || toiduser.ipath == null){
        return "img/default.png";
    }else{
        return toiduser.ipath;
    }
}
var oldt=""
function getmessagetime(t) {
    if(oldt == ""){
        oldt = t;
        return GetallTimestrxs(t);
    }
    if(t-oldt > 300000) {
        oldt = t;
        return GetallTimestrxs(t);
    }else{
        return "";
    }
}
</script>