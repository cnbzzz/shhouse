<!DOCTYPE html>
<head>
    <title>一对一聊天</title>
    <meta charset="utf-8">
    <script src="http://cdn.bootcss.com/sockjs-client/1.1.1/sockjs.min.js"></script>
    <script src="http://cdn.bootcss.com/stomp.js/2.3.3/stomp.js"></script>
    <script src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function(){
//            connect();
            //checkoutUserlist();
        });

        var stompClient = null;

        var baseUrl = "http://www.darunjia.cn";

        function setConnected(connected) {
            document.getElementById('connect').disabled = connected;
            document.getElementById('disconnect').disabled = !connected;

            document.getElementById('fromuserid').disabled = connected;
            document.getElementById('touserid').disabled = connected;
        }

        function getLocalTime(nS) {
            return new Date(parseInt(nS)).toLocaleString().replace(/:\d{1,2}$/,' ');
        }

        //this line.
        function ajax(url, param, func) {
            $.ajax({
                url: url,
                type: 'POST', //GET
                async: true,    //或false,是否异步
                data: param,
                timeout: 5000,    //超时时间
                dataType: 'json',    //返回的数据格式：json/xml/html/script/jsonp/text
                beforeSend: function (xhr) {
                    console.log(xhr);
                    console.log('发送前');
                },
                success: function (data, textStatus, jqXHR) {
                    console.log(data);
                    console.log(textStatus);
                    console.log(jqXHR);
                    func && func(data);
                },
                error: function (xhr, textStatus) {
                    console.log('错误');
                    console.log(xhr);
                    console.log(textStatus);
                },
                complete: function () {
                    console.log('结束');
                }
            })
        }

        function queryUnreadMsg(fromuserid) {
            var url = baseUrl+"/msg/queryUnreadMessageByToUserId";
            ajax(url, {"toUserId" : fromuserid}, function(data){showRespMsg(data);});
        }

        function markMsgRead(fromuserid) {
            var url = baseUrl+"/msg/markMessageReadByToUserId";
            ajax(url, {"toUserId" : fromuserid});
        }

        function connect() {
            var fromuserid = $('#fromuserid').val();
            var touserid = $('#touserid').val();

            if(!fromuserid || !touserid){
                alert("请输入发送方和接收方");
                return false;
            }

            var socket = new SockJS(baseUrl+"/ws/connect");
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                setConnected(true);
                console.log('Connected: ' + frame);

                stompClient.subscribe('/user/' + fromuserid + '/message',function(greeting){
                    showMsg(JSON.parse(greeting.body));
                });

                queryUnreadMsg(fromuserid);//得到未读消息

                markMsgRead(fromuserid);//标记未读消息为已读
            });
        }

        function disconnect() {
            if (stompClient != null) {
                stompClient.disconnect();
            }
            setConnected(false);
            console.log("Disconnected");
        }


        function showRespMsg(msg) {
            if(msg.retCode == '1'){//成功
                var tmpArr = msg.data;
                showMsg(tmpArr);
            }
        }

        function showMsg(msg) {
            var msgArr = [];

            if(msg instanceof Array){
                var tmpArr = msg;
                for(var i = 0; i < tmpArr.length; i++){
                    var tmp = tmpArr[i];
                    var fromuserid = tmp.fromuserid;
                    var touserid = tmp.touserid;
                    var createtime = tmp.createtime;
                    var content = tmp.content;
                    msgArr.push(["[", getLocalTime(createtime), "]", fromuserid, "对", touserid, "说：", content].join(''));
                }
            } else{
                var tmp = msg;
                var fromuserid = tmp.fromuserid;
                var touserid = tmp.touserid;
                var createtime = tmp.createtime;
                var content = tmp.content;
                msgArr.push(["[", getLocalTime(createtime), "]", fromuserid, "对", touserid, "说：", content].join(''));
            }


            for(var i = 0; i < msgArr.length; i++){
                var response = document.getElementById('response');
                var p = document.createElement('p');
                p.style.wordWrap = 'break-word';
                p.appendChild(document.createTextNode(msgArr[i]));
                response.appendChild(p);
            }
        }

        function sendMsg(){
            var fromuserid = $('#fromuserid').val();
            var touserid = $('#touserid').val();
            var content = $('#content').val();

            if(!fromuserid || !touserid || !content){
                alert("请输入发送方、接收方、内容");
                return false;
            }

            if(stompClient == null){
                alert("请先上线");
            }

            var url = baseUrl+"/msg/sendMessage";
            var param = {"fromuserid":fromuserid,"touserid":touserid,"content":content};
            ajax(url, {"data":JSON.stringify(param)}, function(data){showRespMsg(data);});
        }
    </script>
</head>
<body>
<noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable
    Javascript and reload this page!</h2></noscript>

<fieldset style="width: 50%; margin: auto">
    <legend>聊天区域</legend>
    <table style="width: 70%;height: 100%">
        <tr>
            <td>发送方:</td>
            <td><input type="text" id="fromuserid" name="fromuserid" /></td>
        </tr>
        <tr>
            <td>接收方:</td>
            <td><input type="text" id="touserid" name="touserid" /></td>
        </tr>
        <tr>
            <td style="vertical-align: top; ">发送内容:</td>
            <td><textarea rows="3" cols="30" id="content" name="content"></textarea></td>
        </tr>
        <tr>
            <td><button id="connect" onclick="connect();">上线</button></td>
            <td><button id="disconnect" disabled="disabled" onclick="disconnect();">下线</button></td>
            <td><button id="sendName" onclick="sendMsg();">发送</button></td>
        </tr>
    </table>

</fieldset>

<fieldset style="width: 50%; margin: auto" id="response">
    <legend>消息区域</legend>
</fieldset>
</body>
</html>